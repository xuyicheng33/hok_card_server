# 服务器端战斗计算 - 测试清单

## ✅ 已完成的功能

### 服务器端
- [x] CardDatabase.js - 卡牌数据库
- [x] BattleEngine.js - 战斗计算引擎
  - [x] 暴击判定（权威）
  - [x] 闪避判定（权威）
  - [x] 伤害计算（权威）
  - [x] 技能计算（简化版）
- [x] server.js - 服务器主逻辑
  - [x] 房间管理（host/guest）
  - [x] 游戏状态初始化
  - [x] 战斗引擎创建
  - [x] 操作广播

### 客户端
- [x] NetworkManager.gd - 简化为只发送操作
- [x] BattleManager.gd - 接收并应用服务器结果
  - [x] UI更新逻辑
  - [x] 回合同步
  - [x] 被动技能防重复

## 🧪 测试步骤

### 1. 启动服务器
```bash
cd f:\QQ\Downloads\hok_card\server
npm start
```
预期输出：
```
=================================
王者荣耀卡牌游戏服务器已启动
监听端口: 3000
WebSocket: ws://localhost:3000
=================================
```

### 2. 启动两个客户端
使用 `start_game_test.bat`

### 3. 创建房间
窗口1：
- 点击"在线对战"
- 点击"创建房间"
- 记录房间号（1-9）

预期日志：
```
[连接] 玩家连接: player_xxx
[房间创建] 1
```

### 4. 加入房间
窗口2：
- 点击"在线对战"
- 输入房间号
- 点击"加入房间"

预期日志：
```
[加入房间] player_yyy 加入 1
[游戏开始] 1
[游戏初始化] 1 战斗引擎创建完成
```

### 5. 测试攻击
窗口1（房主，回合1）：
- 点击公孙离
- 点击对方澜
- 观察伤害

预期日志：
```
服务器：
[游戏操作] 1 attack
[战斗计算] 公孙离 -> 澜: 350伤害 (暴击:false, 闪避:false)

窗口1：
🌐 已发送攻击操作到服务器
🎮 服务器攻击结果: blue_gongsunli -> red_lan (伤害:350, ...)
🎨 已更新UI: 澜

窗口2：
🎮 服务器攻击结果: blue_gongsunli -> red_lan (伤害:350, ...)
🎨 已更新UI: 澜
```

### 6. 测试暴击
多次攻击，观察是否触发暴击（30%概率）

预期：
- 暴击伤害：455（350 * 1.3）
- 两边显示完全一致

### 7. 测试闪避
公孙离攻击公孙离（如果有）

预期：
- 30%概率闪避
- 闪避时伤害为0
- 两边完全一致

### 8. 测试回合切换
窗口1：
- 点击"结束回合"

预期日志：
```
窗口1：
🌐 全局回合 2 (客户端行动)，本地是房主，对方回合

窗口2：
🌐 全局回合 2 (客户端行动)，本地是客户端，我方回合
```

### 9. 测试被动技能
回合2开始时：

预期日志（窗口2）：
```
🌐 我方回合，触发player_cards被动技能
朵莉亚被动技能「欢歌」发动：生命值 900->900 (已满)，溢出75点转为护盾
```

预期日志（窗口1）：
```
🌐 对方回合，跳过被动技能处理
```

## ❗ 已知问题

### 技能系统
- ⚠️ 技能伤害简化为固定200
- ⚠️ 未实现具体技能效果
- ⚠️ 需要后续完善

### 被动技能
- ⚠️ 孙尚香50%概率：双方独立判定
- ⚠️ 少司缘45%概率：双方独立判定
- 🔧 需要服务器端统一处理

## ✅ 核心功能验证

- [ ] 伤害计算完全一致
- [ ] 暴击判定完全一致
- [ ] 闪避判定完全一致
- [ ] UI实时更新
- [ ] 回合数同步
- [ ] 被动技能不重复触发
- [ ] 房间管理正常
- [ ] 断线重连（未实现）

## 🚀 下一步

1. 测试通过本地功能
2. 部署到Render.com
3. 测试公网连接
4. 完善技能系统
5. 添加断线重连
